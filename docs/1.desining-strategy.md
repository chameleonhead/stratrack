# 戦略の作成

## 概略

UI から戦略のテンプレートを作成し、そのテンプレートから backtrader のプログラムを作成する。
プログラムの作成後はテンプレートを編集してもコードを編集しても OK とする。

```
[ モバイルUI ]
 └─ テンプレート選択（例：MAクロス、ドンチャン）
 └─ パラメータ入力（期間・ロット・TP/SL など）
 └─ 条件をGUIで構築（if A then buy）

     ↓（DSL/フォーム → Backtrader Python戦略に変換）

[ Pythonバックエンド or クライアントPython実行 ]
 └─ Backtraderでバックテスト
 └─ 結果可視化（損益曲線・トレード履歴）
```

## 戦略テンプレートについて

戦略テンプレートでは、以下の要素ごとの戦略に分解して記述する。
| 番号 | 戦略カテゴリ | 説明 | 例 |
|------|----------------------------------|--------------------------------------------------|--------------------------------------------------------------------|
| ① | エントリー戦略（Entry Logic） | どの条件で新規ポジションを取るか | ゴールデンクロス、RSI が 30 以下、特定時間帯など |
| ② | 保有中戦略（Position Management） | ポジションを持った後の保持条件や追加注文 | トレーリングストップ、ピラミッディング、ナンピン、利確・損切り条件の調整 |
| ③ | イグジット戦略（Exit Logic） | どの条件で決済するか | RSI が 70 を超えた、逆シグナルが発生、時間経過など |
| ④ | リスク管理・ロット戦略（Risk / Position Sizing） | どれだけの数量を取引するか、損失制限をどう設定するか | 資産の 2%を最大損失、ATR によるロット調整、固定ロット |
| ⑤ | 環境認識・フィルター（Filter / Context） | 取引するかどうかの大局判断 | トレンド相場かどうか、ボラティリティが高いか、指標発表前は取引しないなど |
| ⑥ | タイミング制御・時間帯指定（Timing Control） | 取引可能な時間帯や曜日の制限 | 東京時間は取引しない、月曜日は避ける、16:00〜23:00 のみ取引 |
| ⑦ | 複数ポジション戦略（Multi-position Handling） | 複数通貨・複数ポジションの制御 | 最大保持数、同時トレード制限、通貨ごとの優先順位 |

# 戦略テンプレート編集 UI 構築のための WBS

## 1. 戦略テンプレート構築基盤

| ID  | タスク                              | 詳細                                                   |
| --- | ----------------------------------- | ------------------------------------------------------ |
| 1.1 | 戦略テンプレート形式の定義          | JSON or YAML 形式で、7 セクションの構造化データを定義  |
| 1.2 | テンプレート一覧の設計              | 「ドンチャンチャネル戦略」などの登録・読み込みロジック |
| 1.3 | テンプレートと GUI のマッピング設計 | 各セクションごとにどの UI コンポーネントを使うか定義   |

## 2. GUI コンポーネント設計（各セクション）

| ID  | タスク                 | 詳細                                                                      |
| --- | ---------------------- | ------------------------------------------------------------------------- |
| 2.1 | Entry Logic 入力 UI    | 条件式ビルダー、インジケータ選択、比較対象選択（例：価格 > チャネル上限） |
| 2.2 | Position Management UI | トレール幅、TP/SL、追加エントリー設定                                     |
| 2.3 | Exit Logic UI          | 中央線クロス、条件式入力                                                  |
| 2.4 | Risk UI                | ロット設定（固定/％）、SL/TP の単位（pips/率）入力欄                      |
| 2.5 | Filter UI              | トレンド・ボラティリティ・指標発表除外などのオプション                    |
| 2.6 | Timing UI              | 時間帯指定（時間スライダー or ドロップダウン）、曜日選択                  |
| 2.7 | Multi-Position UI      | 最大ポジ数、通貨ペア制御のトグル設定等                                    |

## 3. UI レイアウト構築

| ID  | タスク                             | 詳細                                                      |
| --- | ---------------------------------- | --------------------------------------------------------- |
| 3.1 | モバイル向けレイアウト設計         | Tailwind ベースでカード UI ＋セクション切り替え形式を検討 |
| 3.2 | 各セクションの UI パーツ実装       | フォーム・選択肢・スライダー・条件ブロックなどを構築      |
| 3.3 | 入力バリデーションとプリセット反映 | テンプレートロード時に値を初期化／編集制限対応            |

## 4. コード生成・確認・保存

| ID  | タスク                               | 詳細                                               |
| --- | ------------------------------------ | -------------------------------------------------- |
| 4.1 | パラメータから Backtrader コード生成 | テンプレートとパラメータを元に Python コードを構築 |
| 4.2 | 生成コードの表示・コピー UI          | Ace Editor or read-only コードビューの設置         |
| 4.3 | 戦略保存／ロード                     | ローカル or クラウド保存、バージョン管理準備       |

## 5. テストとデプロイ

| ID  | タスク                   | 詳細                                                        |
| --- | ------------------------ | ----------------------------------------------------------- |
| 5.1 | モバイル環境での UX 検証 | スマホ表示・タップ動作・フォーム入力最適化                  |
| 5.2 | 入力・出力の整合性テスト | テンプレート →UI→ コード → 実行で期待通り動作するか検証     |
| 5.3 | MVP リリース             | 初期テンプレート + GUI ベース戦略生成を公開・利用可能にする |

# 戦略のメタデータについて

```json
{
  "id": "strategy_abc123",
  "user_id": "user_xyz",
  "name": "Donchian Channel Breakout",
  "description": "ドンチャンチャネルを使ったシンプルなブレイクアウト戦略。",
  "template": {
    // ← GUI定義・パラメータ内容は未定。将来的に構造化。
  },
  "version": "1.0.0",
  "source": "template", // or "custom"
  "tags": ["donchian", "breakout", "trend"],
  "created_at": "2025-03-28T14:00:00Z",
  "updated_at": "2025-03-28T14:15:00Z",

  "visibility": "private", // "public" | "team" | "private"
  "shared_with": ["user_team1", "user_team2"],

  "notes": "検証中。TPを4%、SLを2%に固定。",
  "generated_code": {
    "language": "python",
    "engine": "backtrader",
    "version": "0.1",
    "code": "class DonchianStrategy(bt.Strategy):\n  def __init__(self): ..."
  },

  "backtest_results": {
    "summary": {
      "total_trades": 42,
      "win_rate": 0.57,
      "net_profit": 1234.56,
      "max_drawdown": -220.1
    },
    "last_run_at": "2025-03-28T14:20:00Z",
    "data_source": "DukasCopy",
    "time_range": {
      "from": "2024-01-01",
      "to": "2024-12-31"
    }
  }
}
```

---

## ✅ 説明・設計意図

| フィールド名                 | 内容                                              | 備考                                                                          |
| ---------------------------- | ------------------------------------------------- | ----------------------------------------------------------------------------- |
| `id`                         | 戦略の一意な ID                                   | DB 用。UUID など                                                              |
| `user_id`                    | 所有者の ID                                       |                                                                               |
| `name`                       | 戦略の名称                                        | GUI 表示用                                                                    |
| `description`                | 戦略の概要                                        | GUI 表示用                                                                    |
| `template`                   | **戦略構成そのもの**                              | 未確定なので保留。将来は DSL/GUI 入力に基づく構造体                           |
| `version`                    | バージョン番号                                    | バージョン情報は自動的にインクリメントする                                    |
| `source　`                     | ソースの状態                                      | `template` または `custom` でソースがテンプレートから生成されるかどうかを管理 |
| `tags`                       | 検索やフィルタ用                                  | 複数可                                                                        |
| `visibility` / `shared_with` | 公開設定と共有ユーザー                            | コラボ・チーム用途向け                                                        |
| `notes`                      | ユーザーの自由メモ欄                              |                                                                               |
| `generated_code`             | Backtrader 等で実行可能な Python コードの生成結果 | バージョンとエンジン記録も可                                                  |
| `backtest_results`           | 簡易サマリ                                        | 実行ログ、期間、データソース情報付き。重くなるなら別コレクション化も可能      |

---

## 🔄 今後の拡張性も考慮済み

- **バージョン履歴管理**：戦略を編集・保存するたびに履歴を残す設計にも対応可能
- **公開ギャラリー／いいね機能**：`visibility = public` + スター数などを付与すれば OK
- **バックテスト結果の蓄積**：`backtest_results`を複数記録に拡張可 or 別エンティティ化

---

## ✳️ 次のステップ候補

1. `template` キーに入る構造のたたき台作成（まだ未確定）
2. このメタ情報スキーマで保存できるよう、画面構成または API 設計
3. `generated_code` の生成エンジンの土台づくり

---

このメタ情報スキーマをベースに、テンプレート仕様が固まってきたら、DSL or GUI 設計に進めましょう。  
何か追加したいフィールド・使いたい形式があれば遠慮なくどうぞ！
