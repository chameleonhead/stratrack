<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>mql-interpreter Browser Backtest</title>
  </head>
  <body>
    <h1>Browser Backtest (Web Worker)</h1>
    <textarea id="code" style="width: 100%; height: 200px"></textarea>
    <div>
      Timeframe:
      <select id="timeframe">
        <option value="M1">M1</option>
      </select>
    </div>
    <div>
      Parameters (JSON):
      <textarea id="params" style="width: 100%; height: 60px" placeholder='{"Lots":0.1}'></textarea>
    </div>
    <button id="run">Run Backtest</button>
    <pre id="log"></pre>
    <pre id="output"></pre>
    <script type="module">
      const codeArea = document.getElementById("code");
      const runButton = document.getElementById("run");
      const log = document.getElementById("log");
      const output = document.getElementById("output");
      const timeframe = document.getElementById("timeframe");
      const params = document.getElementById("params");

      // Load sample MQL into the textarea
      fetch("./MACD%20Sample.mq4")
        .then((r) => r.text())
        .then((t) => {
          codeArea.value = t;
        });

      runButton.addEventListener("click", () => {
        log.textContent = "";
        output.textContent = "";
        const worker = new Worker("./browser-backtest-worker.js", { type: "module" });
        worker.onmessage = (e) => {
          if (e.data.type === "log") {
            log.textContent += `${e.data.message}\n`;
          }
          if (e.data.type === "result") {
            output.textContent = JSON.stringify(e.data.report, null, 2);
            worker.terminate();
          }
        };
        let parsed = {};
        if (params.value.trim()) {
          try {
            parsed = JSON.parse(params.value);
          } catch (err) {
            log.textContent += `Invalid parameters: ${err}\n`;
            worker.terminate();
            return;
          }
        }
        worker.postMessage({ mql: codeArea.value, timeframe: timeframe.value, params: parsed });
      });
    </script>
  </body>
</html>
